---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroFeature from '../components/HeroFeature.astro';
import FeatureCard from '../components/FeatureCard.astro';
import { topicCategorySlug } from '../lib/topicMap';

const allFeatures = await getCollection('features');

// Sort by date DESC, then ph_rank ASC within a date
allFeatures.sort((a, b) => {
  if (b.data.date !== a.data.date) return b.data.date.localeCompare(a.data.date);
  return a.data.ph_rank - b.data.ph_rank;
});

// 15–18 most recent features for the main grid
const recentFeatures = allFeatures.slice(0, 18);
const hero = recentFeatures[0];
const grid1 = recentFeatures.slice(1, 3);   // 2-up row
const grid2 = recentFeatures.slice(3, 6);   // 3-up row
const grid3 = recentFeatures.slice(6, 9);   // 3-up row
const grid4 = recentFeatures.slice(9, 12);  // 3-up row
const grid5 = recentFeatures.slice(12, 14); // 2-up row
const grid6 = recentFeatures.slice(14, 18); // 4-up row (small)

// Most popular: all features sorted by ph_votes DESC, top 8
const mostPopular = [...allFeatures]
  .sort((a, b) => b.data.ph_votes - a.data.ph_votes)
  .slice(0, 8);
---

<BaseLayout
  title="HUGE Magazine — startup features worth reading"
  description="We write about new software companies and the people building them. Real opinions, no press releases."
>
  <Header />

  <main>
    <div class="container">

      <!-- About blurb -->
      <div class="about-blurb">
        <p class="blurb-text">
          Every day we pick a handful of new products, actually look at them, and write honestly about what's interesting and what's not.
          No PR, no placements, no affiliate deals. Just our writers and their real opinions.
        </p>
      </div>

      <hr class="divider" />

      <!-- Hero -->
      {hero && <HeroFeature feature={hero} />}

      <!-- 2-up -->
      {grid1.length > 0 && (
        <div class="grid-2">
          {grid1.map(f => <FeatureCard feature={f} />)}
        </div>
      )}

      <!-- 3-up -->
      {grid2.length > 0 && (
        <div class="grid-3">
          {grid2.map(f => <FeatureCard feature={f} />)}
        </div>
      )}

      <!-- 3-up -->
      {grid3.length > 0 && (
        <div class="grid-3">
          {grid3.map(f => <FeatureCard feature={f} />)}
        </div>
      )}

      <!-- Most popular sidebar widget -->
      <div class="popular-section">
        <div class="grid-main-col">
          <!-- 3-up continues -->
          {grid4.length > 0 && (
            <div class="grid-3">
              {grid4.map(f => <FeatureCard feature={f} />)}
            </div>
          )}
          {grid5.length > 0 && (
            <div class="grid-2">
              {grid5.map(f => <FeatureCard feature={f} />)}
            </div>
          )}
        </div>

        <aside class="popular-widget">
          <h2 class="popular-label">Most popular</h2>
          <ul class="popular-list">
            {mostPopular.map(f => (
              <li class="popular-item">
                <a href={`/feature/${f.slug}`} class="popular-link">
                  <img
                    src={f.data.logo}
                    alt={f.data.ph_slug}
                    width="36"
                    height="36"
                    class="popular-logo"
                    loading="lazy"
                  />
                  <div class="popular-meta">
                    <span class="popular-name">{f.data.ph_slug}</span>
                    <span class="popular-tagline">{f.data.tagline}</span>
                  </div>
                </a>
              </li>
            ))}
          </ul>
        </aside>
      </div>

      <!-- Final 4-up row -->
      {grid6.length > 0 && (
        <div class="grid-4">
          {grid6.map(f => <FeatureCard feature={f} />)}
        </div>
      )}

    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  /* ── About blurb ── */
  .about-blurb {
    padding: 2rem 0 1rem;
    max-width: 640px;
  }

  .blurb-text {
    font-size: 1rem;
    line-height: 1.65;
    color: var(--text-secondary);
  }

  /* ── Grids ── */
  .grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    margin-top: 1.25rem;
  }

  .grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
    margin-top: 1.25rem;
  }

  .grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: 1.25rem;
    margin-bottom: 3rem;
  }

  /* ── Popular section layout ── */
  .popular-section {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 2rem;
    align-items: start;
    margin-top: 1.25rem;
  }

  .grid-main-col {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  /* ── Popular widget ── */
  .popular-widget {
    position: sticky;
    top: 90px;
    border: 1px solid var(--border);
    border-radius: var(--radius-card);
    background: #fff;
    padding: 1.25rem;
  }

  .popular-label {
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 1rem;
  }

  .popular-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .popular-item {
    border-bottom: 1px solid var(--border);
  }

  .popular-item:last-child {
    border-bottom: none;
  }

  .popular-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.7rem 0;
    text-decoration: none;
    transition: opacity 0.15s;
  }

  .popular-link:hover {
    opacity: 0.75;
  }

  .popular-logo {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }

  .popular-meta {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    min-width: 0;
  }

  .popular-name {
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .popular-tagline {
    font-size: 0.7rem;
    color: var(--text-secondary);
    line-height: 1.35;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ── Mobile ── */
  @media (max-width: 900px) {
    .popular-section {
      grid-template-columns: 1fr;
    }

    .popular-widget {
      position: static;
      order: -1;
    }

    .grid-3 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .grid-2,
    .grid-3,
    .grid-4 {
      grid-template-columns: 1fr;
    }
  }
</style>
