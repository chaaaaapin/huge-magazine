---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroFeature from '../../components/HeroFeature.astro';
import FeatureCard from '../../components/FeatureCard.astro';

export async function getStaticPaths() {
  const features = await getCollection('features');

  // Collect unique dates
  const dates = [...new Set(features.map(f => f.data.edition))];

  return dates.map(date => {
    const dateFeatures = features
      .filter(f => f.data.edition === date)
      .sort((a, b) => a.data.ph_rank - b.data.ph_rank);

    return {
      params: { date },
      props: { date, features: dateFeatures },
    };
  });
}

const { date, features } = Astro.props;

const hero = features[0];
const supporting = features.slice(1, 3);

function formatDate(dateStr: string) {
  const d = new Date(dateStr + 'T12:00:00Z');
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
}

const displayDate = formatDate(date);
---

<BaseLayout
  title={`Edition: ${displayDate}`}
  description={`HUGE Magazine — ${displayDate} edition. Three startup features, covered in depth.`}
>
  <Header />

  <main>
    <div class="container">

      <div class="edition-header">
        <a href="/" class="back-link">← Latest edition</a>
        <div class="edition-bar">
          <span class="edition-label">Edition</span>
          <span class="edition-dot">·</span>
          <span class="edition-date">{displayDate}</span>
        </div>
      </div>

      <hr class="divider" />

      {hero && <HeroFeature feature={hero} />}

      {supporting.length > 0 && (
        <div class="supporting-grid">
          {supporting.map(f => <FeatureCard feature={f} />)}
        </div>
      )}

    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .edition-header {
    padding: 1.5rem 0 0.5rem;
  }

  .back-link {
    display: inline-block;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: 1rem;
    transition: color 0.15s;
  }

  .back-link:hover {
    color: var(--accent);
  }

  .edition-bar {
    display: flex;
    align-items: baseline;
    gap: 0.6rem;
  }

  .edition-label {
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-secondary);
  }

  .edition-dot {
    color: var(--border);
  }

  .edition-date {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .supporting-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    margin-bottom: 3rem;
  }

  @media (max-width: 768px) {
    .supporting-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
